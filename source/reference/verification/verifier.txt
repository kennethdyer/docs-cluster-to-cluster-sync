.. _c2c-migration-verifier:

==============================
Verify with Migration Verifier
==============================

.. default-domain:: mongodb

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 1
   :class: singlecol

Migration Verifier connects to the source and destination clusters and performs
a series of verification checks, comparing documents, views, and indexes to
confirm the sync was successful.

.. important::

   Migration Verifier is an experimental and unsupported tool.

   For installation instructions, see
   `GitHub <https://github.com/mongodb-labs/migration-verifier>`__.

Steps
-----

.. procedure::

   .. step:: Start Migration Verifier

      Start the ``migration-verifier`` process:

      .. code-block:: bash

         migration-verifier --verifyAll \
            --srcURI example.net:27020 \
            --destURI example.net:27021 \
            --metaURI example.net:27017

   .. step:: Start the Verification Checks

      To start the verification checks, use cURL to send the ``check`` command to
      Migration Verifier:

      .. code-block:: bash

         curl -H "Content-Type: application/json" \
             -X POST -d '{}' http://127.0.0.1:27020/api/v1/check

   .. step:: Sync Clusters

      Run :program:`mongosync` to sync the source and destination clusters.

   .. step:: Signal Sync Completion

      When the sync is complete and :program:`mongosync` has reached the
      ``COMMITTED`` state, use cURL to send the ``writesOff`` command to
      Migration Verifier:

      .. code-block:: bash

         curl -H "Content-Type: application/json" \
             -X POST -d '{}' http://127.0.0.1:27020/api/v1/writesOff

   .. step:: Check Progress

      To view the results, use cURL to send the ``progress`` command to
      Migration Verifier.

      .. io-code-block::

         .. input::
            :language: bash

            curl -H "Content-Type: application/json" \
               -X GET http://127.0.0.1:27020/api/v1/progress

         .. output::
            :language: json

            {
               "progress": {
                  "phase": "idle",
                  "error": null,
                  "verificationStatus": {
                     "totalTasks": 1,
                     "addedTasks": 0,
                     "processingTasks": 0,
                     "failedTasks": 0,
                     "completedTasks": 0,
                     "metadataMismatchTasks": 0,
                     "recheckTasks": 0
                  }
               }
            }


      When the ``phase`` field returns ``idle``, the verification checks are
      complete. If the ``failedTasks`` field returns 0, the sync was successful.

Learn More
----------

- :ref:`c2c-verify-doc-counts`
- :ref:`c2c-verify-hash-comp`
- `Migration Verifier on GitHub <https://github.com/mongodb-labs/migration-verifier>`__.


